<div class="contenedor">
    <mat-horizontal-stepper [linear]="isLinear" #stepper>
        <!-- Paso Facturación -->
        <mat-step [stepControl]="firstFormGroup" [editable]="isEditable" [completed]="false">
            <ng-template matStepLabel>Factura de Compra</ng-template>
            <nav class="navbar-light nav-fijo">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#" role="button" (click)="nuevo($event)">
                            <fa-icon [icon]="['fas', 'file']"></fa-icon>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" role="button" (click)="crear($event)"
                            *ngIf="cliente.id==0; else block_actualizar">
                            <fa-icon [icon]="['fas', 'save']"></fa-icon>
                        </a>
                        <ng-template #block_actualizar>
                            <a class="nav-link" href="#" role="button" (click)="actualizar($event)">
                                <fa-icon [icon]="['fas', 'save']"></fa-icon>
                            </a>
                        </ng-template>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" role="button" (click)="$event.preventDefault()">
                            <fa-icon [icon]="['fas', 'file-import']"></fa-icon>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" role="button" (click)="$event.preventDefault()">
                            <fa-icon [icon]="['fas', 'file-export']"></fa-icon>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            &nbsp;&nbsp;&nbsp;&nbsp;<i><u>FACTURA DE COMPRA</u></i>
                        </div>
                        <div class="card-body">
                            <div class="form-row col-12">
                                <div class="form-group col-2">
                                    <mat-form-field appearance="standard">
                                        <mat-label>Fecha</mat-label>
                                        <input matInput type="date" value="{{factura.fecha | date:'yyyy-MM-dd'}}"
                                            class="form-control-sm">
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-1">
                                    <mat-form-field appearance="standard">
                                        <mat-label>Estab.</mat-label>
                                        <input matInput type="text" class="form-control-sm"
                                            [(ngModel)]="factura.vendedor.punto_venta.establecimiento.codigo">
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-1">
                                    <mat-form-field appearance="standard">
                                        <mat-label>Punto V.</mat-label>
                                        <input matInput type="text" class="form-control-sm"
                                            [(ngModel)]="factura.vendedor.punto_venta.codigo">
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-2">
                                    <mat-form-field appearance="standard">
                                        <mat-label>Secuencia</mat-label>
                                        <input matInput type="text" class="form-control-sm"
                                            [(ngModel)]="factura.numero">
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-2">
                                    <mat-form-field appearance="standard">
                                        <mat-label>Documento</mat-label>
                                        <mat-select [(ngModel)]="cliente.grupo_cliente.id" class="form-control-sm">
                                            <mat-option *ngFor="let grupo_cliente of grupos_clientes"
                                                [value]="grupo_cliente.id">
                                                {{grupo_cliente.descripcion}}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-2">
                                    <br>
                                    <mat-checkbox [(ngModel)]="cliente.tipo_contribuyente.obligado_contabilidad"
                                        class="form-control-sm" color="primary">S. Créd. Trib.</mat-checkbox>
                                </div>
                                <div class="form-group col-2">
                                    <mat-form-field appearance="standard">
                                        <mat-label>Estado</mat-label>
                                        <mat-select class="form-control-sm" [(ngModel)]="estado">
                                            <mat-option value="EMITIDA">EMITIDA</mat-option>
                                            <mat-option value="ANULADA">ANULADA</mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-2">
                                    <mat-form-field appearance="standard">
                                        <mat-label>Identificación</mat-label>
                                        <input matInput type="text" [(ngModel)]="cliente.identificacion"
                                            oninput="this.value = this.value.toUpperCase()" class="form-control-sm"
                                            (change)="validar_identificacion()">
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-8">
                                    <mat-form-field appearance="standard" class="grande">
                                        <mat-label>Razón Social</mat-label>
                                        <input matInput type="text" [(ngModel)]="cliente.razon_social"
                                            oninput="this.value = this.value.toUpperCase()" class="form-control-sm">
                                        <button mat-button *ngIf="cliente.razon_social" matSuffix mat-icon-button
                                            (click)="cliente.razon_social=''">
                                            <mat-icon>close</mat-icon>
                                        </button>
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-2">
                                    <mat-form-field appearance="standard">
                                        <mat-label>Deuda Actual</mat-label>
                                        <input matInput type="text" class="form-control-sm"
                                            [(ngModel)]="cliente.tipo_identificacion" disabled>
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-6">
                                    <mat-form-field appearance="standard" class="grande">
                                        <mat-label>Autorización</mat-label>
                                        <input matInput type="text" [(ngModel)]="cliente.codigo"
                                            class="form-control-sm">
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-2">
                                    <mat-form-field appearance="standard">
                                        <mat-label>Referencia</mat-label>
                                        <mat-select [(ngModel)]="cliente.grupo_cliente.id" class="form-control-sm">
                                            <mat-option *ngFor="let grupo_cliente of grupos_clientes"
                                                [value]="grupo_cliente.id">
                                                {{grupo_cliente.descripcion}}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-2">
                                    <mat-form-field appearance="standard" class="grande">
                                        <mat-label>No. Referencia</mat-label>
                                        <input matInput type="text" [(ngModel)]="cliente.codigo"
                                            class="form-control-sm">
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-2">
                                    <br>
                                    <button mat-raised-button color="primary" focusable="false" (click)="guardar(i)">
                                        Importar Factura
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <mat-accordion class="headers-align">
                <mat-expansion-panel (opened)="panelOpenState = true" (closed)="panelOpenState = false">
                    <mat-expansion-panel-header>
                        <mat-panel-title>
                            <i><u>DETALLE FACTURA</u></i>
                        </mat-panel-title>
                        <mat-panel-description>
                            {{panelOpenState ? 'Ocultar sección' : 'Ingresar la ubicacion del cliente'}}
                            <mat-icon>map</mat-icon>
                        </mat-panel-description>
                    </mat-expansion-panel-header>
                    <mat-divider></mat-divider>
                    <div class="row">
                        <div class="form-row col-12">
                            <div class="form-group col-2">
                                <mat-form-field appearance="standard" class="grande">
                                    <mat-label>Código</mat-label>
                                    <input matInput type="text" class="form-control-sm"
                                        [(ngModel)]="detalle.producto.codigo" disabled>
                                </mat-form-field>
                            </div>
                            <div class="form-group col-1">
                                <mat-form-field appearance="standard">
                                    <mat-label>B/S/AF</mat-label>
                                    <input matInput type="text" [(ngModel)]="detalle.producto.tipo_producto.abreviatura"
                                        class="form-control-sm" disabled>
                                </mat-form-field>
                            </div>
                            <div class="form-group col-1">
                                <mat-form-field appearance="standard">
                                    <mat-label>Consig.</mat-label>
                                    <mat-select class="form-control-sm" [(ngModel)]="detalle.producto.consignacion"
                                        disabled>
                                        <mat-option [value]="false">NO</mat-option>
                                        <mat-option [value]="true">SI</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                            <div class="form-group col-1">
                                <mat-form-field appearance="standard">
                                    <mat-label>Ult. Costo</mat-label>
                                    <input matInput type="text" [(ngModel)]="costo_ultimo" class="form-control-sm"
                                        disabled>
                                </mat-form-field>
                            </div>
                            <div class="form-group col-1">
                                <mat-form-field appearance="standard">
                                    <mat-label>Costo Prom</mat-label>
                                    <input matInput type="text" [(ngModel)]="costo_promedio" class="form-control-sm"
                                        disabled>
                                </mat-form-field>
                            </div>
                            <div class="form-group col-1">
                                <mat-form-field appearance="standard">
                                    <mat-label>Saldo</mat-label>
                                    <input matInput type="text" class="form-control-sm" [(ngModel)]="stock_individual"
                                        disabled>
                                </mat-form-field>
                            </div>
                            <div class="form-group col-1 ">
                                <mat-form-field appearance="standard">
                                    <mat-label>S. Total</mat-label>
                                    <input matInput type="text " class="form-control-sm " [(ngModel)]="stock_total"
                                        disabled>
                                </mat-form-field>
                            </div>
                            <div class="form-group col-2">
                                <mat-form-field appearance="standard">
                                    <mat-label>Dist con IVA</mat-label>
                                    <input matInput type="text" class="form-control-sm" [(ngModel)]="stock_individual">
                                </mat-form-field>
                            </div>
                            <div class="form-group col-2">
                                <mat-form-field appearance="standard">
                                    <mat-label>Dist sin IVA</mat-label>
                                    <input matInput type="text" class="form-control-sm" [(ngModel)]="stock_individual">
                                </mat-form-field>
                            </div>
                            <mat-divider></mat-divider>
                        </div>
                        <div class="form-row col-12">
                            <div class="form-group col-7">
                                <mat-form-field appearance="standard" class="grande">
                                    <mat-label>Producto</mat-label>
                                    <mat-autocomplete #producto="matAutocomplete" [displayWith]="ver_producto"
                                        (optionSelected)="seleccionar_producto()">
                                        <mat-option *ngFor="let producto of filtro_productos | async"
                                            [value]="producto">
                                            {{producto.nombre}}
                                        </mat-option>
                                    </mat-autocomplete>
                                    <input matInput type="text" class="form-control-sm" placeholder="Producto"
                                        [formControl]="seleccion_producto" [matAutocomplete]="producto">
                                </mat-form-field>
                            </div>
                            <div class="form-group col-1">
                                <mat-form-field appearance="standard">
                                    <mat-label>PR</mat-label>
                                    <mat-select class="form-control-sm"
                                        (selectionChange)="cambiar_productos($event.value)" [(value)]="tipo_producto">
                                        <mat-option value="B">B</mat-option>
                                        <mat-option value="S">S</mat-option>
                                        <mat-option value="AF">AF</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                            <div class="form-group col-3">
                                <mat-form-field appearance="standard">
                                    <mat-label>Bodega</mat-label>
                                    <mat-select class="form-control-sm" [(ngModel)]="detalle.producto.bodega">
                                        <mat-option *ngFor="let bodega of bodegas; let i=index" [value]="bodega">
                                            {{bodega.codigo}}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                            <div class="form-group col-1 ">
                                <br>
                                <button class="btn btn-primary btn-circle " disabled>
                                    <fa-icon [icon]="[ 'fas', 'eye'] "></fa-icon>
                                </button>&nbsp;&nbsp;
                                <button class="btn btn-primary btn-circle" (click)="agregar_factura_detalle()">
                                    <fa-icon [icon]="[ 'fas', 'plus'] "></fa-icon>
                                </button>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-1">
                                    <mat-form-field appearance="standard" class="grande">
                                        <mat-label>Cantidad</mat-label>
                                        <input matInput type="text" [(ngModel)]="detalle.cantidad"
                                            (change)="seleccionar_cantidad()" class="form-control-sm">
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-1">
                                    <mat-form-field appearance="standard" class="grande">
                                        <mat-label>Medida</mat-label>
                                        <mat-select [(ngModel)]="detalle.medida" class="form-control-sm">
                                            <mat-option *ngFor="let medida of medidas" [value]="medida">
                                                {{medida.descripcion}}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-1">
                                    <mat-form-field appearance="standard" class="grande">
                                        <mat-label>P. Unit.</mat-label>
                                        <mat-select (selectionChange)="seleccionar_precio()"
                                            [(ngModel)]="detalle.precio" class="form-control-sm">
                                            <mat-option *ngFor="let precio of detalle.producto.precios"
                                                [value]="precio">
                                                {{precio.valor}}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-1">
                                    <mat-form-field appearance="standard" class="grande">
                                        <mat-label>Desc. $</mat-label>
                                        <input matInput type="text" step="0.01"
                                            [(ngModel)]="detalle.valor_descuento_individual"
                                            (change)="seleccionar_valor_descuento_individual()" class="form-control-sm">
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-1">
                                    <mat-form-field appearance="standard" class="grande">
                                        <mat-label>Desc. %</mat-label>
                                        <input matInput type="text" min="0" max="100" step="0.01"
                                            [(ngModel)]="detalle.porcentaje_descuento_individual"
                                            (change)="seleccionar_porcentaje_descuento_individual()"
                                            class="form-control-sm">
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-1">
                                    <mat-form-field appearance="standard" class="grande">
                                        <mat-label>IVA</mat-label>
                                        <mat-select class="form-control-sm" [(ngModel)]="detalle.impuesto">
                                            <mat-option *ngFor="let impuesto of impuestos" [value]="impuesto">
                                                {{impuesto.porcentaje}}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-1">
                                    <mat-form-field appearance="standard" class="grande">
                                        <mat-label>TOTAL</mat-label>
                                        <input matInput type="text" [(ngModel)]="detalle.total_con_descuento"
                                            class="form-control-sm" disabled>
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-1">
                                    <mat-form-field appearance="standard" class="grande">
                                        <mat-label>Inventario</mat-label>
                                        <mat-select class="form-control-sm" [(ngModel)]="detalle_entregado">
                                            <mat-option value="F1">I</mat-option>
                                            <mat-option value="F2">C</mat-option>
                                            <mat-option value="F3">G</mat-option>
                                            <mat-option value="F4">P</mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                                <div class="form-group col-4">
                                    <mat-form-field appearance="outline" class="grande">
                                        <mat-label>Comentario</mat-label>
                                        <textarea matInput [(ngModel)]="detalle.comentario"
                                            placeholder="Referente al producto..." class="form-control form-control-sm "
                                            rows="2"></textarea>
                                    </mat-form-field>
                                </div>
                            </div>
                        </div>
                        <mat-divider></mat-divider>
                        <div class="form-row">
                            <div class="mat-elevation-z8 col-12">
                                <table mat-table [dataSource]="data_detalle_factura_prueba" matSort>
                                    <!-- Nombre Columna -->
                                    <ng-container matColumnDef="nombre">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Producto </th>
                                        <td mat-cell *matCellDef="let detalle"> {{detalle.nombre}} </td>
                                    </ng-container>
                                    <!-- Entregado Columna -->
                                    <ng-container matColumnDef="entregado">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Entreg </th>
                                        <td mat-cell *matCellDef="let detalle"> {{detalle.entregado}} </td>
                                    </ng-container>
                                    <!-- Descripcion Columna -->
                                    <ng-container matColumnDef="descripcion">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Descripcion </th>
                                        <td mat-cell *matCellDef="let detalle"> {{detalle.descripcion}} </td>
                                    </ng-container>
                                    <!-- Cantidad Columna -->
                                    <ng-container matColumnDef="cantidad">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Cant </th>
                                        <td mat-cell *matCellDef="let detalle"> {{detalle.cantidad}} </td>
                                    </ng-container>
                                    <!-- Valor Columna -->
                                    <ng-container matColumnDef="valor">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Valor </th>
                                        <td mat-cell *matCellDef="let detalle"> {{detalle.valor | currency}} </td>
                                    </ng-container>
                                    <!-- Descuento Columna -->
                                    <ng-container matColumnDef="descuento">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Desc. </th>
                                        <td mat-cell *matCellDef="let detalle"> {{detalle.descuento}} </td>
                                    </ng-container>
                                    <!-- Descuento% Columna -->
                                    <ng-container matColumnDef="desc_por">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Desc% </th>
                                        <td mat-cell *matCellDef="let detalle"> {{detalle.desc_por}} </td>
                                    </ng-container>
                                    <!-- Descuento SubTotal Columna -->
                                    <ng-container matColumnDef="desc_sub">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Desc. ST. </th>
                                        <td mat-cell *matCellDef="let detalle"> {{detalle.desc_sub}} </td>
                                    </ng-container>
                                    <!-- Descuento SubTotal% Columna -->
                                    <ng-container matColumnDef="desc_por_sub">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Desc. ST% </th>
                                        <td mat-cell *matCellDef="let detalle"> {{detalle.desc_por_sub}} </td>
                                    </ng-container>
                                    <!-- Descuento al Total Columna -->
                                    <ng-container matColumnDef="desc_tot">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Desc. T </th>
                                        <td mat-cell *matCellDef="let detalle"> {{detalle.desc_tot}} </td>
                                    </ng-container>
                                    <!-- Descuento al Total % Columna -->
                                    <ng-container matColumnDef="desc_por_tot">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Desc. T% </th>
                                        <td mat-cell *matCellDef="let detalle"> {{detalle.desc_por_tot}} </td>
                                    </ng-container>
                                    <!-- Impuesto Columna -->
                                    <ng-container matColumnDef="impuesto">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> IVA </th>
                                        <td mat-cell *matCellDef="let detalle"> {{detalle.impuesto}} </td>
                                    </ng-container>
                                    <!-- Descuento Columna -->
                                    <ng-container matColumnDef="total">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Total </th>
                                        <td mat-cell *matCellDef="let detalle"> {{detalle.total | currency}} </td>
                                    </ng-container>
                                    <!-- Serie Columna -->
                                    <ng-container matColumnDef="serie">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Serie </th>
                                        <td mat-cell *matCellDef="let i=index">
                                            <button mat-icon-button color="primary" focusable="false"
                                                (click)="asignar_series(modal_series, i)">
                                                <i class="fa fa-plus mat-icon"></i>
                                            </button>
                                        </td>
                                    </ng-container>
                                    <ng-container matColumnDef="acciones">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Acciones </th>
                                        <td mat-cell *matCellDef="let i=index">
                                            <button mat-icon-button color="primary" focusable="false"
                                                (click)="editar_detalle(i)">
                                                <i class="fa fa-pencil mat-icon"></i>
                                            </button>
                                            <button mat-icon-button color="primary" focusable="false"
                                                (click)="eliminar_detalle(i)">
                                                <i class="fa fa-times mat-icon"></i>
                                            </button>
                                        </td>
                                    </ng-container>
                                    <tr mat-header-row *matHeaderRowDef="columnasDetalleFactura"></tr>
                                    <tr mat-row *matRowDef="let row; columns: columnasDetalleFactura;"></tr>
                                </table>
                                <ng-container>
                                    <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons>
                                    </mat-paginator>
                                </ng-container>
                            </div>
                        </div>
                        <div class="form-row col-12">
                            <div class="form-group col-7">
                                <div class="form-row">
                                </div>
                                <div class="form-row">
                                    <mat-form-field appearance="outline" class="grande">
                                        <mat-label>Comentario</mat-label>
                                        <textarea matInput [(ngModel)]="factura.comentario"
                                            placeholder="Referente a la factura..." class="form-control form-control-sm"
                                            rows="2"></textarea>
                                    </mat-form-field>
                                </div>
                            </div>
                            <div class="form-group col-5">
                                <mat-card>
                                    <div class="form-row">
                                        <div class="form-group col-4">
                                            <mat-form-field appearance="standard">
                                                <mat-label>Base 12%</mat-label>
                                                <input matInput type="text "
                                                    [(ngModel)]="factura.subtotal_base12_con_descuento"
                                                    class="form-control-sm " disabled>
                                            </mat-form-field>
                                        </div>
                                        <div class="form-group col-4">
                                            <mat-form-field appearance="standard">
                                                <mat-label>Descuento</mat-label>
                                                <input matInput type="text" [(ngModel)]="factura.descuento_total"
                                                    class="form-control-sm" disabled>
                                            </mat-form-field>
                                        </div>
                                        <div class="form-group col-4">
                                            <mat-form-field appearance="standard">
                                                <mat-label>Subtotal</mat-label>
                                                <input matInput type="text "
                                                    [(ngModel)]="factura.subtotal_sin_descuento"
                                                    class="form-control-sm " disabled>
                                            </mat-form-field>
                                        </div>
                                        <div class="form-group col-4">
                                            <mat-form-field appearance="standard">
                                                <mat-label>Base 0%</mat-label>
                                                <input matInput type="text "
                                                    [(ngModel)]="factura.subtotal_base0_con_descuento"
                                                    class="form-control-sm " disabled>
                                            </mat-form-field>
                                        </div>
                                        <div class="form-group col-4">
                                            <mat-form-field appearance="standard">
                                                <mat-label>Importe IVA</mat-label>
                                                <input matInput type="text "
                                                    [(ngModel)]="factura.importe_iva_con_descuento"
                                                    class="form-control-sm " disabled>
                                            </mat-form-field>
                                        </div>
                                        <div class="form-group col-4">
                                            <mat-form-field appearance="standard">
                                                <mat-label>Total</mat-label>
                                                <input matInput type="text" [(ngModel)]="factura.total_con_descuento"
                                                    class="form-control-sm" disabled>
                                            </mat-form-field>
                                        </div>
                                    </div>
                                </mat-card>
                            </div>
                        </div>
                    </div>
                </mat-expansion-panel>

                <mat-expansion-panel (opened)="panelOpenState = true" (closed)="panelOpenState = false">
                    <mat-expansion-panel-header>
                        <mat-panel-title>
                            <i><u>RETENCIÓN EN COMPRAS</u></i>
                        </mat-panel-title>
                        <mat-panel-description>
                            {{panelOpenState ? 'Ocultar sección' : 'Ingresar datos adicionales'}}
                            <mat-icon>date_range</mat-icon>
                        </mat-panel-description>
                    </mat-expansion-panel-header>
                    <div class="form-row col-12">
                        <div class="form-group col-2">
                            <mat-form-field appearance="standard">
                                <mat-label>Fecha</mat-label>
                                <input matInput type="date" value="{{factura.fecha | date:'yyyy-MM-dd'}}"
                                    class="form-control-sm">
                            </mat-form-field>
                        </div>
                        <div class="form-group col-1">
                            <mat-form-field appearance="standard">
                                <mat-label>Estab.</mat-label>
                                <input matInput type="text" class="form-control-sm"
                                    [(ngModel)]="factura.vendedor.punto_venta.establecimiento.codigo">
                            </mat-form-field>
                        </div>
                        <div class="form-group col-1">
                            <mat-form-field appearance="standard">
                                <mat-label>Punto V.</mat-label>
                                <input matInput type="text" class="form-control-sm"
                                    [(ngModel)]="factura.vendedor.punto_venta.codigo">
                            </mat-form-field>
                        </div>
                        <div class="form-group col-2">
                            <mat-form-field appearance="standard">
                                <mat-label>Secuencia</mat-label>
                                <input matInput type="text" class="form-control-sm" [(ngModel)]="factura.numero">
                            </mat-form-field>
                        </div>
                        <div class="form-group col-2">
                            <mat-form-field appearance="standard">
                                <mat-label>Documento</mat-label>
                                <mat-select [(ngModel)]="cliente.grupo_cliente.id" class="form-control-sm">
                                    <mat-option *ngFor="let grupo_cliente of grupos_clientes"
                                        [value]="grupo_cliente.id">
                                        {{grupo_cliente.descripcion}}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="form-group col-2"></div>
                        <div class="form-group col-2">
                            <mat-form-field appearance="standard">
                                <mat-label>Estado</mat-label>
                                <mat-select class="form-control-sm" [(ngModel)]="estado">
                                    <mat-option value="EMITIDA">EMITIDA</mat-option>
                                    <mat-option value="ANULADA">ANULADA</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="form-group col-6">
                            <mat-form-field appearance="standard" class="grande">
                                <mat-label>Autorización</mat-label>
                                <input matInput type="text" [(ngModel)]="cliente.codigo" class="form-control-sm">
                            </mat-form-field>
                        </div>
                        <div class="form-group col-4"></div>
                        <div class="form-group col-2">
                            <br>
                            <button mat-raised-button color="primary" focusable="false" (click)="guardar(i)">
                                Generar retención
                            </button>
                        </div>
                    </div>
                    <mat-divider></mat-divider>
                    <div class="form-row col-12">
                        <div class="mat-elevation-z8 expandir">
                            <table mat-table [dataSource]="data_retencion" matSort>
                                <!-- Periodo Columna -->
                                <ng-container matColumnDef="periodo">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Periodo </th>
                                    <td mat-cell *matCellDef="let retencion"> {{retencion.periodo}} </td>
                                </ng-container>
                                <!-- Establecimientos Columna -->
                                <ng-container matColumnDef="establecimiento">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Establ. </th>
                                    <td mat-cell *matCellDef="let retencion"> {{retencion.establecimiento}} </td>
                                </ng-container>
                                <!-- Serie Columna -->
                                <ng-container matColumnDef="serie">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Serie </th>
                                    <td mat-cell *matCellDef="let retencion"> {{retencion.serie}} </td>
                                </ng-container>
                                <!-- Comprobante Columna -->
                                <ng-container matColumnDef="comprobante">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Comprobante </th>
                                    <td mat-cell *matCellDef="let retencion"> {{retencion.comprobante}} </td>
                                </ng-container>
                                <!-- Tipo Retención Columna -->
                                <ng-container matColumnDef="tipo">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Tipo </th>
                                    <td mat-cell *matCellDef="let retencion"> {{retencion.tipo}} </td>
                                </ng-container>
                                <!-- Código retención Columna -->
                                <ng-container matColumnDef="codigo">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Código </th>
                                    <td mat-cell *matCellDef="let retencion"> {{retencion.codigo}} </td>
                                </ng-container>
                                <!-- Descripcion Columna -->
                                <ng-container matColumnDef="descripcion">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Descripción </th>
                                    <td mat-cell *matCellDef="let retencion"> {{retencion.descripcion}} </td>
                                </ng-container>
                                <!-- Base Imponible Columna -->
                                <ng-container matColumnDef="base">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Base </th>
                                    <td mat-cell *matCellDef="let retencion"> {{retencion.base | currency}} </td>
                                </ng-container>
                                <!-- Porcentaje aplicable de retención Columna -->
                                <ng-container matColumnDef="porcentaje">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Porc. </th>
                                    <td mat-cell *matCellDef="let retencion"> {{retencion.porcentaje}} </td>
                                </ng-container>
                                <!-- Valor Columna -->
                                <ng-container matColumnDef="valor">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Valor </th>
                                    <td mat-cell *matCellDef="let retencion"> {{retencion.valor | currency}} </td>
                                </ng-container>
                                <ng-container matColumnDef="acciones">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Acciones </th>
                                    <td mat-cell *matCellDef="let i=index">
                                        <button mat-icon-button color="primary" focusable="false"
                                            (click)="editar_detalle(i)">
                                            <i class="fa fa-pencil mat-icon"></i>
                                        </button>
                                        <button mat-icon-button color="primary" focusable="false"
                                            (click)="eliminar_detalle(i)">
                                            <i class="fa fa-times mat-icon"></i>
                                        </button>
                                    </td>
                                </ng-container>
                                <tr mat-header-row *matHeaderRowDef="columnasRetencion"></tr>
                                <tr mat-row *matRowDef="let row; columns: columnasRetencion;"></tr>
                            </table>
                            <ng-container>
                                <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
                            </ng-container>
                        </div>
                    </div>
                </mat-expansion-panel>
            </mat-accordion>
            <div>
                <button mat-button matStepperNext>Siguiente</button>
            </div>
        </mat-step>
        <!-- Paso Pago -->
        <mat-step [stepControl]="secondFormGroup" [completed]="false" [editable]="isEditable">
            <ng-template matStepLabel>Pago Compra</ng-template>
            <app-pago-compra [factura]="factura_crear"></app-pago-compra>
            <mat-divider></mat-divider>
            <div>
                <button mat-button matStepperPrevious>Atras</button>
                <button mat-button (click)="stepper.reset()">Terminar</button>
            </div>
        </mat-step>
    </mat-horizontal-stepper>
</div>

<!-- Modals-->
<ng-template #modal_importar let-modal>
    <div class="modal-header ">
        <h5 class="modal-title ">Importar un Cliente</h5>
        <button type="button " class="close " aria-label="Close " (click)="modal.dismiss( 'Cross click') ">
            <span aria-hidden="true ">&times;</span>
        </button>
    </div>
    <div class="modal-body ">
        <div class="form-row ">
            <div class="form-group col-12 ">
                <label>Cargar Archivo</label>
                <input type="file" id="file" (change)="importar($event.target.files)">
            </div>
        </div>
    </div>
    <div class="modal-footer ">
        <button type="button " class="btn btn-outline-dark " (click)="modal.close('close') ">Cerrar</button>
    </div>
</ng-template>
<ng-template #modal_telefono let-modal>
    <div class="modal-header ">
        <h5 class="modal-title ">Ver Telefonos</h5>
        <button type="button " class="close " aria-label="Close " (click)="modal.dismiss( 'Cross click') ">
            <span aria-hidden="true ">&times;</span>
        </button>
    </div>
    <div class="modal-body ">
        <div class="form-group form-row ">
            <table class="table table-striped ">
                <thead>
                    <tr>
                        <th>NUMERO</th>
                        <th>OPCION</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let telefono of cliente.telefonos; let i=index ">
                        <td>
                            {{telefono.numero}}
                        </td>
                        <td>
                            <button class="btn btn-primary btn-circle " (click)="eliminar_telefono(i) ">
                                <fa-icon [icon]="[ 'fas', 'trash'] "></fa-icon>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="modal-footer ">
        <button type="button " class="btn btn-outline-dark " (click)="modal.close( 'close') ">Cerrar</button>
    </div>
</ng-template>
<ng-template #modal_celular let-modal>
    <div class="modal-header ">
        <h5 class="modal-title ">Ver Celulares</h5>
        <button type="button " class="close " aria-label="Close " (click)="modal.dismiss( 'Cross click') ">
            <span aria-hidden="true ">&times;</span>
        </button>
    </div>
    <div class="modal-body ">
        <div class="form-group form-row ">
            <table class="table table-striped ">
                <thead>
                    <tr>
                        <th>NUMERO</th>
                        <th>OPCION</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let celular of cliente.celulares; let i = index ">
                        <td>
                            {{celular.numero}}
                        </td>
                        <td>
                            <button class="btn btn-primary btn-circle " (click)="eliminar_celular(i) ">
                                <fa-icon [icon]="[ 'fas', 'trash'] "></fa-icon>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="modal-footer ">
        <button type="button " class="btn btn-outline-dark " (click)="modal.close( 'close') ">Cerrar</button>
    </div>
</ng-template>
<ng-template #modal_correo let-modal>
    <div class="modal-header ">
        <h5 class="modal-title ">Ver Correos</h5>
        <button type="button " class="close " aria-label="Close " (click)="modal.dismiss( 'Cross click') ">
            <span aria-hidden="true ">&times;</span>
        </button>
    </div>
    <div class="modal-body ">
        <div class="form-group form-row ">
            <table class="table table-striped ">
                <thead>
                    <tr>
                        <th>CORREO</th>
                        <th>OPCION</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let correo of cliente.correos; let i= index ">
                        <td>
                            {{correo.email}}
                        </td>
                        <td>
                            <button class="btn btn-primary btn-circle " (click)="eliminar_correo(i) ">
                                <fa-icon [icon]="[ 'fas', 'trash'] "></fa-icon>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="modal-footer ">
        <button type="button " class="btn btn-outline-dark " (click)="modal.close('close') ">Cerrar</button>
    </div>
</ng-template>
<ng-template #modal_auxiliar let-modal>
    <div class="modal-header">
        <h5 class="modal-title ">Ver Auxiliares</h5>
        <button type="button " class="close " aria-label="Close " (click)="modal.dismiss( 'Cross click') ">
            <span aria-hidden="true ">&times;</span>
        </button>
    </div>
    <div class="modal-body ">
        <div class="form-group form-row ">
            <table class="table table-striped ">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Direccion</th>
                        <th>Provincia</th>
                        <th>Canton</th>
                        <th>Parroquia</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let auxiliar of cliente.auxiliares; let i= index ">
                        <td>
                            {{auxiliar.razon_social}}
                        </td>
                        <td>
                            {{auxiliar.direccion.direccion}}
                        </td>
                        <td>
                            <ng-container *ngIf="auxiliar.direccion.ubicacion != null">
                                {{auxiliar.direccion.ubicacion.provincia}}</ng-container>
                        </td>
                        <td>
                            <ng-container *ngIf="auxiliar.direccion.ubicacion != null">
                                {{auxiliar.direccion.ubicacion.canton}}</ng-container>
                        </td>
                        <td>
                            <ng-container *ngIf="auxiliar.direccion.ubicacion != null">
                                {{auxiliar.direccion.ubicacion.parroquia}}</ng-container>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-circle " (click)="eliminar_auxiliar(i) ">
                                <fa-icon [icon]="[ 'fas', 'trash'] "></fa-icon>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="modal-footer ">
        <button type="button " class="btn btn-outline-dark " (click)="modal.close( 'close') ">Cerrar</button>
    </div>
</ng-template>
<ng-template #modal_telefono_auxiliar let-modal>
    <div class="modal-header ">
        <h5 class="modal-title ">Ver Telefonos</h5>
        <button type="button " class="close " aria-label="Close " (click)="modal.dismiss( 'Cross click') ">
            <span aria-hidden="true ">&times;</span>
        </button>
    </div>
    <div class="modal-body ">
        <div class="form-group form-row ">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>AUXILIAR</th>
                        <th>DIRECCION</th>
                        <th>TELEFONOS</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            {{auxiliar.razon_social}}
                        </td>
                        <td>
                            {{auxiliar.direccion.direccion}}
                        </td>
                        <td>
                            <table class="table table-bordered ">
                                <tbody>
                                    <tr *ngFor="let telefono of auxiliar.telefonos; let i= index">
                                        <td>{{telefono.numero}}</td>
                                        <td>
                                            <button class="btn btn-primary btn-circle "
                                                (click)="eliminar_telefono_auxiliar(i) ">
                                                <fa-icon [icon]="[ 'fas', 'trash'] "></fa-icon>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="modal-footer ">
        <button type="button " class="btn btn-outline-dark " (click)="modal.close( 'close') ">Cerrar</button>
    </div>
</ng-template>
<ng-template #modal_celular_auxiliar let-modal>
    <div class="modal-header ">
        <h5 class="modal-title ">Ver Celulares</h5>
        <button type="button " class="close " aria-label="Close " (click)="modal.dismiss( 'Cross click') ">
            <span aria-hidden="true ">&times;</span>
        </button>
    </div>
    <div class="modal-body ">
        <div class="form-group form-row ">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>AUXILIAR</th>
                        <th>DIRECCION</th>
                        <th>CELULAR</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            {{auxiliar.razon_social}}
                        </td>
                        <td>
                            {{auxiliar.direccion.direccion}}
                        </td>
                        <td>
                            <table class="table table-bordered ">
                                <tbody>
                                    <tr *ngFor="let celular of auxiliar.celulares; let i= index">
                                        <td>{{celular.numero}}</td>
                                        <td>
                                            <button class="btn btn-primary btn-circle "
                                                (click)="eliminar_celular_auxiliar(i) ">
                                                <fa-icon [icon]="[ 'fas', 'trash'] "></fa-icon>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="modal-footer ">
        <button type="button " class="btn btn-outline-dark " (click)="modal.close( 'close') ">Cerrar</button>
    </div>
</ng-template>
<ng-template #modal_correo_auxiliar let-modal>
    <div class="modal-header ">
        <h5 class="modal-title ">Ver Correos</h5>
        <button type="button " class="close " aria-label="Close " (click)="modal.dismiss( 'Cross click') ">
            <span aria-hidden="true ">&times;</span>
        </button>
    </div>
    <div class="modal-body ">
        <div class="form-group form-row ">
            <table class="table table-bordered ">
                <thead>
                    <tr>
                        <th>AUXILIAR</th>
                        <th>DIRECCION</th>
                        <th>CORREOS</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            {{auxiliar.razon_social}}
                        </td>
                        <td>
                            {{auxiliar.direccion.direccion}}
                        </td>
                        <td>
                            <table class="table table-bordered ">
                                <tbody>
                                    <tr *ngFor="let correo of auxiliar.correos; let i= index">
                                        <td>{{correo.email}}</td>
                                        <td>
                                            <button class="btn btn-primary btn-circle "
                                                (click)="eliminar_correo_auxiliar(i) ">
                                                <fa-icon [icon]="[ 'fas', 'trash'] "></fa-icon>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="modal-footer ">
        <button type="button " class="btn btn-outline-dark " (click)="modal.close('close') ">Cerrar</button>
    </div>
</ng-template>